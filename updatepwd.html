<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>冬笋云 | 更新密码</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.7 -->
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">

    <!-- Ionicons -->
    <link rel="stylesheet" href="bower_components/Ionicons/css/ionicons.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/AdminLTE.min.css">
    <!-- iCheck -->
    <link rel="stylesheet" href="plugins/iCheck/square/blue.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Google Font -->
    <!--<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">-->
</head>
<body class="hold-transition register-page">
<div class="register-box">
    <div class="register-logo">
        <a href="/index.html"><b>冬笋</b>云</a>
    </div>

    <div class="register-box-body">
        <p class="login-box-msg">更新密码</p>

        <form>
            <div class="form-group has-feedback">
                <input name="password" type="password" class="form-control update popover-pwd"  data-placement="top" data-content=""  placeholder="输入密码">
                <span class="glyphicon glyphicon-lock form-control-feedback"></span>
            </div>
            <div class="form-group has-feedback">
                <input name="reinput" type="password" class="form-control update  popover-reinput"  data-placement="top" data-content=""  placeholder="请再次输入">
                <span class="glyphicon glyphicon-lock form-control-feedback"></span>
            </div>
            <div class="row">
                <!--<div class="col-xs-8">-->
                <!--<div class="checkbox icheck">-->
                <!--<label>-->
                <!--<input type="checkbox"> 我同意 <a href="#">条款</a>-->
                <!--</label>-->
                <!--</div>-->
                <!--</div>-->
                <!-- /.col -->
                <div class="col-xs-12">
                    <button name="update" type="button" class="btn btn-primary btn-block btn-flat update">确定</button>
                </div>
                <!-- /.col -->
            </div>
        </form>


    </div>
    <!-- /.form-box -->
</div>
<!-- /.register-box -->

<!-- jQuery 3 -->
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<!-- Bootstrap 3.3.7 -->
<script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<!-- iCheck -->
<script src="plugins/iCheck/icheck.min.js"></script>
<!-- bootstrap-notify -->
<script src="bower_components/bootstrap-notify/js/bootstrap-notify.min.js"></script>

<!-- load common js-->
<script src="user_js/common/jQuery.cookie.js"></script>
<script src="user_js/common/common.js"></script>
<!--<script src="user_js/common/user.js"></script>-->

<script>
    $(function () {
        $('input').iCheck({
            checkboxClass: 'icheckbox_square-blue',
            radioClass: 'iradio_square-blue',
            increaseArea: '20%' /* optional */
        });

        update_key  = getParam('update_key');
        if(update_key==null){
            // redirect('/');
        }

        // update按钮
        $(".update:button[name='update']").click(function(){
            var new_pwd = $(".update:input[name='password']").val();
            var re_new_pwd = $(".update:input[name='reinput']").val();
            var last_pwd = "";
            if (new_pwd == "" || new_pwd == null) {
                $(".update:input[name='password']").data("content", "密码不能为空");
                $('.popover-pwd').popover('show');
                setTimeout(function () {
                    $('.popover-pwd').popover('destroy');
                },2000);
                return false;
            }
            if (!/^.{6,99}$/.test(new_pwd)) {
                $(".update:input[name='password']").data("content", "密码不能少于6个字符");
                $('.popover-pwd').popover('show');
                setTimeout(function () {
                    $('.popover-pwd').popover('destroy');
                },2000);
                return false;
            }
            if (re_new_pwd == "" || re_new_pwd == null) {
                $(".update:input[name='reinput']").data("content", "密码不能为空");
                $('.popover-reinput').popover('show');
                setTimeout(function () {
                    $('.popover-reinput').popover('destroy');
                },2000);
                return false;
            }
            if (re_new_pwd !== new_pwd ) {
                $(".update:input[name='reinput']").data("content", "两次输入密码不一致");
                $('.popover-reinput').popover('show');
                setTimeout(function () {
                    $('.popover-reinput').popover('destroy');
                },2000);
                return false;
            }else{
                last_pwd = re_new_pwd;

                updatepwd(update_key, "", last_pwd)

            }

            return false;

            if(checkUsername(full_name)){
                var email = $(".register:input[name='email']").val();
                if(email==''){
                    $(".register:input[name='email']").data("content", "邮箱不能为空");
                    $('.popover-email').popover('show');
                    setTimeout(function () {
                        $('.popover-email').popover('destroy');
                    },2000);
                    return false;
                }else{
                    console.log("22")
                    var mailReg = /^(\w-*\.*)+@(\w-?)+(\.\w{2,})+$/;
                    if(mailReg.test(email)){
                        console.log("33")

                        register(full_name, email);
                        return true;
                    }else{
                        console.log("44")
                        $(".register:input[name='email']").data("content", "邮箱格式不合法");
                        $('.popover-email').popover('show');
                        setTimeout(function () {
                            $('.popover-email').popover('destroy');
                        },2000);
                        return false;
                    }
                }
            }



        });

        /**
         *	用户更新密码
         */
        function updatepwd(update_key, old_password, new_password){
            $.ajax({
                url: '/apis/api/method/frappe.core.doctype.user.user.update_password?key='+ update_key  + '&new_password='+ new_password + '&old_password=' + old_password,
                headers: {
                    Accept: "application/json; charset=utf-8"
                },
                type: 'get',
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                dataType:'json',
                success:function(req){
                    console.log('密码重置-----------------------------------------',req);
                    $(".update:button[name='update']").attr("disabled", false);
                    if(req.message) {

                        $.notify({
                            title: "<strong>提示:</strong><br><br> ",
                            message: req.message
                        }, {
                            type: 'warning'
                        });


                        // if (req.message == "无法更新：不正确的/过期的链接。") {
                        //
                        //     $.notify({
                        //         title: "<strong>提示:</strong><br><br> ",
                        //         message: '用户不存在'
                        //     }, {
                        //         type: 'warning'
                        //     });
                        //
                        // }
                    }
                    if(req._server_messages){
                        var ret = JSON.parse(req._server_messages)[0];
                        if(ret!=""){
                            ret = JSON.parse(ret);
                        }
                        if(ret.message){
                            $.notify({
                                title: "<strong>提示:</strong><br><br> ",
                                message: '申请重置成功，' + ret.message + '<br>' + '登录邮箱'+ email + '完成密码重置'
                            },{
                                type: 'success'
                            });
                        }
                    }



                    delCookie('auth_token');
                    // setTimeout("redirect('login.html')", 1500);
                },
                error:function(req){
                    console.log('错误-----------------------------------------',req);
                    $(".update:button[name='update']").attr("disabled", false);
                }
            });

        }
    });
</script>
</body>
</html>
